<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ˜ìµ ì‹œë®¬ë ˆì´í„° ë¦¬í¬íŠ¸</title>

  <!-- XLSX -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <!-- PDF (html2pdf includes html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f7f8ff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#667085;
      --line:#e7e9ef;
      --soft:#f2f4ff;

      --brand:#2563eb;
      --brand2:#ec4899;

      --good:#027a48;
      --warn:#b54708;

      --r:18px;
      --shadow: 0 12px 30px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(1000px 700px at 95% 10%, rgba(236,72,153,.12), transparent 55%),
        linear-gradient(180deg, #f7f8ff, #ffffff 45%, #f7f8ff);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:14px;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{width:42px; height:42px; border-radius:14px; background:linear-gradient(135deg,var(--brand),var(--brand2)); box-shadow:var(--shadow);}
    .brand h1{font-size:16px; margin:0; letter-spacing:-.2px;}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted);}

    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      color:var(--text);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    button:disabled{opacity:.65; cursor:not-allowed; transform:none !important;}
    button.primary{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff; border:none;
      box-shadow:0 10px 18px rgba(37,99,235,.18), 0 10px 18px rgba(236,72,153,.14);
    }
    button.primary:hover{filter:brightness(1.02); transform:translateY(-1px);}

    .seg{
      display:inline-flex; border:1px solid var(--line); background:#fff; border-radius:14px;
      overflow:hidden; box-shadow:var(--shadow);
    }
    .seg input{display:none;}
    .seg label{
      padding:9px 10px; font-size:12px; font-weight:950; color:#334155;
      cursor:pointer; user-select:none; display:inline-flex; align-items:center; gap:6px;
    }
    .seg label + label{border-left:1px solid var(--line);}
    .seg input:checked + label{
      background: linear-gradient(135deg, rgba(37,99,235,.12), rgba(236,72,153,.12));
      color:#0b1220;
    }

    .grid{display:grid; gap:14px;}
    .grid-2{grid-template-columns: 1fr 1.25fr;}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr;} }

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--r); padding:16px; box-shadow:var(--shadow);}
    .card h2{margin:0 0 10px; font-size:15px; letter-spacing:-.2px;}
    .sub{margin:0 0 12px; color:var(--muted); font-size:12px; line-height:1.5;}
    .sectionTitle{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;}
    .pill{font-size:11px; font-weight:900; padding:6px 10px; border-radius:999px; background:var(--soft); border:1px solid var(--line); color:var(--muted); white-space:nowrap;}

    .formGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width: 640px){ .formGrid{grid-template-columns:1fr;} }
    label{display:block; font-size:12px; color:#344054; margin-bottom:6px; font-weight:800;}
    input{width:100%; padding:11px 12px; border-radius:14px; border:1px solid var(--line); outline:none; font-size:14px; background:#fff;}
    input.hi{background:#fff7cc; border-color:#f1d470;}
    .help{font-size:11px; color:var(--muted); margin-top:6px;}

    #report{background:#fff; border-radius:var(--r); border:1px solid var(--line); overflow:hidden;}
    .cover{
      padding:18px 18px 14px;
      background: linear-gradient(135deg, #0b1220, rgba(37,99,235,.95), rgba(236,72,153,.90));
      color:#fff; position:relative;
    }
    .cover::after{
      content:""; position:absolute; inset:-40px;
      background: radial-gradient(400px 240px at 20% 20%, rgba(255,255,255,.18), transparent 60%),
                  radial-gradient(420px 260px at 85% 30%, rgba(255,255,255,.14), transparent 62%);
      pointer-events:none;
    }
    .coverRow{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; position:relative; z-index:1;}
    .cover h3{margin:0; font-size:18px; letter-spacing:-.3px;}
    .cover .meta{margin-top:6px; color: rgba(255,255,255,.80); font-size:12px; line-height:1.5;}
    .cover .stamp{text-align:right; font-size:11px; color: rgba(255,255,255,.78);}
    .cover .stamp .big{display:block; font-size:14px; font-weight:900; color:#fff; margin-top:4px;}
    .cover .badge{
      display:inline-flex; align-items:center; gap:8px;
      margin-top:12px; padding:8px 10px;
      background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18);
      border-radius:999px; font-size:12px;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:#fff;}
    .reportBody{padding:16px;}

    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px;}
    @media (max-width: 840px){ .kpis{grid-template-columns:1fr;} }
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:
        radial-gradient(280px 140px at 12% 10%, rgba(37,99,235,.08), transparent 60%),
        radial-gradient(260px 140px at 90% 20%, rgba(236,72,153,.08), transparent 62%),
        linear-gradient(180deg, #ffffff, #fbfbfd);
    }
    .kpi .t{font-size:12px; color:var(--muted); font-weight:800;}
    .kpi .v{font-size:22px; margin-top:8px; font-weight:950; letter-spacing:-.4px;}
    .kpi .s{font-size:11px; margin-top:6px; color:var(--muted); line-height:1.45;}
    .kpi.good .v{color:var(--good);}
    .kpi.warn .v{color:var(--warn);}

    .twoCols{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;}
    @media (max-width: 840px){ .twoCols{grid-template-columns:1fr;} }

    .box{border:1px solid var(--line); border-radius:16px; padding:12px; background:#fff;}
    .box h4{margin:0 0 8px; font-size:13px;}
    .kv{display:grid; grid-template-columns: 1fr auto; gap:8px 12px; font-size:12px;}
    .kv .k{color:var(--muted); font-weight:800;}
    .kv .v{font-weight:900;}

    table{width:100%; border-collapse:collapse; margin-top:12px; font-size:12px;}
    th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:right; vertical-align:middle;}
    th{background:#fafbff; font-weight:950; color:#344054;}
    th:first-child, td:first-child{ text-align:left; }
    .tag{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--soft); border:1px solid var(--line); font-size:11px; font-weight:900; color:#475467;}

    td.yProfit, th.yProfit{background: linear-gradient(180deg, rgba(236,72,153,.10), rgba(37,99,235,.08));}
    td.yProfit{font-weight:950;}
    tr.totalRow td.yProfit{background: linear-gradient(180deg, rgba(236,72,153,.16), rgba(37,99,235,.12));}

    .insight{
      margin-top:12px;
      padding:14px 14px 14px 38px;
      border-radius:16px;
      border: 1px solid rgba(37,99,235,.28);
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(236,72,153,.12)), #ffffff;
      color:#0b1220;
      font-size:12.5px;
      line-height:1.65;
      position:relative;
      box-shadow: 0 10px 24px rgba(37,99,235,.10), 0 10px 24px rgba(236,72,153,.08);
    }
    .insight::before{content:"ğŸ’¡"; position:absolute; top:12px; left:12px; font-size:16px; opacity:.95;}
    .insight b{font-weight:950;}

    .footer{
      margin-top:14px; padding-top:12px; border-top:1px solid var(--line);
      display:flex; justify-content:space-between; gap:12px;
      color:var(--muted); font-size:11px;
    }

    .noPrint{display:block;}
    @media print{
      body{background:#fff;}
      .wrap{max-width:none; margin:0; padding:0;}
      .topbar, .noPrint{display:none !important;}
      .card{box-shadow:none; border:none;}
      #report{border:none;}
      .reportBody{padding:12mm;}
      .cover{padding:12mm; border-radius:0;}
      .pageBreak{break-before: page;}
    }

    #pdfOverlay{
      position: fixed; inset: 0;
      background: rgba(11,18,32,.45);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #pdfOverlay .overlayBox{
      width: min(460px, calc(100% - 32px));
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    #pdfOverlay .t{font-weight:950; margin-bottom:6px;}
    #pdfOverlay .s{color:var(--muted); font-size:12px; line-height:1.5;}
    #pdfOverlay .bar{
      height: 10px; border-radius: 999px; overflow: hidden;
      background: #eef2ff; border: 1px solid var(--line); margin-top: 10px;
    }
    #pdfOverlay .bar > div{
      height: 100%; width: 40%;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      animation: pdfbar 1.05s ease-in-out infinite;
    }
    @keyframes pdfbar{ 0%{transform:translateX(-120%);} 100%{transform:translateX(320%);} }

    #debugPanel{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background:#fff;
      color:#0b1220;
      font-size:12px;
      display:none;
    }
    #debugPanel .h{font-weight:950; margin-bottom:6px;}
    #debugPanel pre{
      margin:0; white-space:pre-wrap; word-break:break-word;
      color:#334155; background:#f8fafc; border:1px solid var(--line);
      border-radius:12px; padding:10px; max-height:220px; overflow:auto;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar noPrint">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="brandName">SIM Revenue Report</h1>
          <p id="brandSub">ì…ë ¥ê°’ ê¸°ë°˜ ìë™ ë¦¬í¬íŠ¸ Â· PDF/ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</p>
        </div>
      </div>

      <div class="actions">
        <div class="seg" role="group" aria-label="PDF í’ˆì§ˆ">
          <input id="qFast" name="pdfQ" type="radio" checked />
          <label for="qFast">âš¡ ë¹ ë¥¸</label>
          <input id="qHigh" name="pdfQ" type="radio" />
          <label for="qHigh">âœ¨ ê³ í™”ì§ˆ</label>
        </div>
        <button id="btnPdf" class="primary">PDF ë‹¤ìš´ë¡œë“œ</button>
        <button id="btnXlsx">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button id="btnPrint">ì¸ì‡„</button>
      </div>
    </div>

    <div id="debugPanel" class="noPrint">
      <div class="h">PDF ë””ë²„ê·¸ ë¡œê·¸</div>
      <pre id="debugText"></pre>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="sectionTitle">
          <h2>ì…ë ¥</h2>
          <span class="pill">ë…¸ë€ ì¹¸ë§Œ ìˆ˜ì •</span>
        </div>
        <p class="sub">ì›” ê²€ì‚¬ ê±´ìˆ˜ì™€ ë‹¨ê°€ ê°€ì •ê°’ì„ ì…ë ¥í•˜ë©´ ë³´ê³ ì„œê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>

        <div class="box" style="margin-bottom:12px;">
          <h4>ë³´ê³ ì„œ ì •ë³´</h4>
          <div class="formGrid">
            <div>
              <label>ë¦¬í¬íŠ¸ ì œëª©</label>
              <input id="reportTitle" class="hi" type="text" value="ë³‘ì› ìˆ˜ìµ ì‹œë®¬ë ˆì´ì…˜ ë¦¬í¬íŠ¸" />
              <div class="help">PDF ì»¤ë²„ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
            <div>
              <label>ê¸°ê´€/í”„ë¡œì íŠ¸ëª…</label>
              <input id="reportOrg" class="hi" type="text" value="OOë³‘ì› Â· AiTiA" />
              <div class="help">ì˜ˆ: ì„¸ë€ë³‘ì› ê²€ì§„ì„¼í„°</div>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="sectionTitle" style="margin:0 0 8px;">
            <h4 style="margin:0;">ì™¸ë˜</h4>
            <span class="tag">ë‹¨ìœ„: ì›</span>
          </div>
          <div class="formGrid">
            <div><label>ì›” ê²€ì‚¬ ê±´ìˆ˜</label><input id="opCount" class="hi" type="number" min="0" value="100" /></div>
            <div><label>í™˜ì ì²­êµ¬ ë‹¨ê°€</label><input id="opPrice" class="hi" type="number" min="0" value="9300" /></div>
            <div><label>êµ¬ë§¤ ë‹¨ê°€</label><input id="opCost" class="hi" type="number" min="0" value="6000" /></div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="box">
          <div class="sectionTitle" style="margin:0 0 8px;">
            <h4 style="margin:0;">ê²€ì§„ì„¼í„°</h4>
            <span class="tag">ë‹¨ìœ„: ì›</span>
          </div>
          <div class="formGrid">
            <div><label>ì›” ê²€ì‚¬ ê±´ìˆ˜</label><input id="scCount" class="hi" type="number" min="0" value="1000" /></div>
            <div><label>ê²€ì§„ ì²­êµ¬ ë‹¨ê°€</label><input id="scPrice" class="hi" type="number" min="0" value="30000" /></div>
            <div><label>êµ¬ë§¤ ë‹¨ê°€</label><input id="scCost" class="hi" type="number" min="0" value="12000" /></div>
          </div>
        </div>
      </div>

      <div id="report" class="card" style="padding:0;">
        <div class="cover">
          <div class="coverRow">
            <div>
              <h3 id="coverTitle">ë³‘ì› ìˆ˜ìµ ì‹œë®¬ë ˆì´ì…˜ ë¦¬í¬íŠ¸</h3>
              <div class="meta" id="coverOrg">OOë³‘ì› Â· AiTiA</div>
              <div class="badge"><span class="dot"></span><span>ì›” ê±´ìˆ˜ ê¸°ì¤€ Â· ì—°ê°„ í™˜ì‚° í¬í•¨</span></div>
            </div>
            <div class="stamp">
              Generated
              <span class="big" id="coverDate">YYYY-MM-DD</span>
            </div>
          </div>
        </div>

        <div class="reportBody" id="reportBody">
          <div class="kpis" id="kpis"></div>

          <div class="twoCols">
            <div class="box">
              <h4>ì…ë ¥ê°’ ìš”ì•½</h4>
              <div class="kv" id="inputSummary"></div>
            </div>
            <div class="box">
              <h4>ê°€ì •ê°’(ë‹¨ê°€) ìš”ì•½</h4>
              <div class="kv" id="assumptionSummary"></div>
            </div>
          </div>

          <div class="box" style="margin-top:14px;">
            <div class="sectionTitle" style="margin:0 0 8px;">
              <h4 style="margin:0;">ìƒì„¸ ê³„ì‚°í‘œ</h4>
              <span class="pill">í‘œê¸° ë‹¨ìœ„: ì²œì›</span>
            </div>
            <table>
              <thead>
                <tr>
                  <th>êµ¬ë¶„</th><th>ì›” ê±´ìˆ˜</th><th>ì›” ë§¤ì¶œ</th><th>ì›” êµ¬ë§¤ë¹„ìš©</th>
                  <th>ì›” ì‹¤ìˆ˜ìµ</th><th>ì—° ë§¤ì¶œ</th><th class="yProfit">ì—° ì‹¤ìˆ˜ìµ</th><th>ë§ˆì§„ìœ¨</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>

            <div class="insight" id="insight"></div>

            <div class="footer">
              <div>Â© <span id="footBrand">SIM Revenue Report</span></div>
              <div id="footNote">* ë³¸ ë¦¬í¬íŠ¸ëŠ” ì…ë ¥ê°’ ê¸°ë°˜ ìë™ ê³„ì‚° ê²°ê³¼ì´ë©°, ì‹¤ì œ ì²­êµ¬/ì •ì‚° ì¡°ê±´ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="pdfOverlay" aria-hidden="true">
    <div class="overlayBox">
      <div class="t">PDF ìƒì„± ì¤‘â€¦</div>
      <div class="s" id="overlayMsg">ì—”ì§„ ì¤€ë¹„ ì¤‘â€¦</div>
      <div class="bar"><div></div></div>
    </div>
  </div>

  <script>
    const won = (n) => new Intl.NumberFormat('ko-KR').format(Math.round(n));
    const wonK = (n) => new Intl.NumberFormat('ko-KR').format(Math.round(n/1000));
    const pct = (n) => (isFinite(n) ? (n*100).toFixed(1) + "%" : "-");
    const todayISO = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };
    document.getElementById("coverDate").textContent = todayISO();

    function calcBlock(count, price, cost){
      const monthlyRevenue = price * count;
      const monthlyCost = cost * count;
      const monthlyProfit = monthlyRevenue - monthlyCost;
      const yearlyRevenue = monthlyRevenue * 12;
      const yearlyProfit = monthlyProfit * 12;
      const margin = monthlyRevenue > 0 ? (monthlyProfit / monthlyRevenue) : NaN;
      return {count, price, cost, monthlyRevenue, monthlyCost, monthlyProfit, yearlyRevenue, yearlyProfit, margin};
    }

    function render(){
      const title = document.getElementById("reportTitle").value || "ìˆ˜ìµ ì‹œë®¬ë ˆì´ì…˜ ë¦¬í¬íŠ¸";
      const org = document.getElementById("reportOrg").value || "";
      document.getElementById("coverTitle").textContent = title;
      document.getElementById("coverOrg").textContent = org;

      const op = calcBlock(+document.getElementById("opCount").value||0, +document.getElementById("opPrice").value||0, +document.getElementById("opCost").value||0);
      const sc = calcBlock(+document.getElementById("scCount").value||0, +document.getElementById("scPrice").value||0, +document.getElementById("scCost").value||0);

      const totalMonthlyRevenue = op.monthlyRevenue + sc.monthlyRevenue;
      const totalMonthlyProfit  = op.monthlyProfit  + sc.monthlyProfit;
      const totalYearlyRevenue  = op.yearlyRevenue  + sc.yearlyRevenue;
      const totalYearlyProfit   = op.yearlyProfit   + sc.yearlyProfit;
      const totalMargin = totalMonthlyRevenue > 0 ? (totalMonthlyProfit / totalMonthlyRevenue) : NaN;

      const kpis = [
        {t:"ì›” ì´ ë§¤ì¶œ(ì›)", v: won(totalMonthlyRevenue), s:"ì™¸ë˜ + ê²€ì§„ì„¼í„° í•©ì‚°", cls:""},
        {t:"ì›” ì´ ì‹¤ìˆ˜ìµ(ì›)", v: won(totalMonthlyProfit), s:"(ë§¤ì¶œ âˆ’ êµ¬ë§¤ë¹„ìš©) í•©ì‚°", cls: totalMonthlyProfit >= 0 ? "good" : "warn"},
        {t:"ì—° ì´ ì‹¤ìˆ˜ìµ(ì›)", v: won(totalYearlyProfit), s:"ì›” ê¸°ì¤€ 12ê°œì›” í™˜ì‚°", cls: totalYearlyProfit >= 0 ? "good" : "warn"},
      ];
      document.getElementById("kpis").innerHTML = kpis.map(k => `
        <div class="kpi ${k.cls}">
          <div class="t">${k.t}</div>
          <div class="v">${k.v}</div>
          <div class="s">${k.s}</div>
        </div>
      `).join("");

      document.getElementById("inputSummary").innerHTML = `
        <div class="k">ì™¸ë˜ ì›” ê±´ìˆ˜</div><div class="v">${won(op.count)}</div>
        <div class="k">ê²€ì§„ ì›” ê±´ìˆ˜</div><div class="v">${won(sc.count)}</div>
        <div class="k">ì›” ì´ ê±´ìˆ˜</div><div class="v">${won(op.count + sc.count)}</div>
        <div class="k">ë¦¬í¬íŠ¸ ìƒì„±ì¼</div><div class="v">${todayISO()}</div>
      `;
      document.getElementById("assumptionSummary").innerHTML = `
        <div class="k">ì™¸ë˜ ë‹¨ê°€</div><div class="v">${won(op.price)}ì›</div>
        <div class="k">ì™¸ë˜ êµ¬ë§¤ë‹¨ê°€</div><div class="v">${won(op.cost)}ì›</div>
        <div class="k">ê²€ì§„ ë‹¨ê°€</div><div class="v">${won(sc.price)}ì›</div>
        <div class="k">ê²€ì§„ êµ¬ë§¤ë‹¨ê°€</div><div class="v">${won(sc.cost)}ì›</div>
      `;

      const row = (name, b) => `
        <tr>
          <td><span class="tag">${name}</span></td>
          <td>${won(b.count)}</td>
          <td>${wonK(b.monthlyRevenue)}</td>
          <td>${wonK(b.monthlyCost)}</td>
          <td>${wonK(b.monthlyProfit)}</td>
          <td>${wonK(b.yearlyRevenue)}</td>
          <td class="yProfit">${wonK(b.yearlyProfit)}</td>
          <td>${pct(b.margin)}</td>
        </tr>
      `;
      document.getElementById("rows").innerHTML =
        row("ì™¸ë˜", op) + row("ê²€ì§„ì„¼í„°", sc) +
        `<tr class="totalRow">
          <td><b>í•©ê³„</b></td>
          <td><b>${won(op.count + sc.count)}</b></td>
          <td><b>${wonK(totalMonthlyRevenue)}</b></td>
          <td><b>${wonK(op.monthlyCost + sc.monthlyCost)}</b></td>
          <td><b>${wonK(totalMonthlyProfit)}</b></td>
          <td><b>${wonK(totalYearlyRevenue)}</b></td>
          <td class="yProfit"><b>${wonK(totalYearlyProfit)}</b></td>
          <td><b>${pct(totalMargin)}</b></td>
        </tr>`;

      document.getElementById("insight").innerHTML =
        `<b>í•µì‹¬ ì¸ì‚¬ì´íŠ¸</b><br>
         â€¢ ì›” ì´ ì‹¤ìˆ˜ìµ: <b>${won(totalMonthlyProfit)}ì›</b><br>
         â€¢ ì—° ì´ ì‹¤ìˆ˜ìµ: <b>${won(totalYearlyProfit)}ì›</b><br>
         â€¢ ì´ ë§ˆì§„ìœ¨: <b>${pct(totalMargin)}</b>`;

      return { totalMonthlyProfit, totalYearlyProfit };
    }

    // debug UI
    const debugPanel = document.getElementById("debugPanel");
    const debugText = document.getElementById("debugText");
    function logDebug(msg){
      debugPanel.style.display = "block";
      debugText.textContent += (debugText.textContent ? "\n" : "") + msg;
    }
    function resetDebug(){ debugText.textContent = ""; debugPanel.style.display = "none"; }
    window.addEventListener("error", (e)=> logDebug("[window.error] " + (e.message || e.error || "unknown")));
    window.addEventListener("unhandledrejection", (e)=> logDebug("[promise] " + (e.reason?.message || e.reason || "unknown")));

    ["reportTitle","reportOrg","opCount","opPrice","opCost","scCount","scPrice","scCost"]
      .forEach(id => document.getElementById(id).addEventListener("input", render));

    document.getElementById("btnPrint").addEventListener("click", () => window.print());

    function getPdfMode(){ return document.getElementById("qHigh").checked ? "high" : "fast"; }

    async function makePdf(mode){
      if (!window.html2pdf) throw new Error("html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      const isMobile = window.matchMedia("(max-width: 840px)").matches;

      // PNGëŠ” ìš©ëŸ‰ì´ ì»¤ì§ˆ ìˆ˜ ìˆì–´ scaleì„ ì¡°ê¸ˆ ë³´ìˆ˜ì ìœ¼ë¡œ
      const scale = (mode === "fast")
        ? (isMobile ? 1.1 : 1.25)   // PNG fast
        : (isMobile ? 1.4 : 1.7);   // PNG high

      const el = (mode === "fast")
        ? document.getElementById("reportBody")
        : document.getElementById("report");

      const filename = `ìˆ˜ìµë¦¬í¬íŠ¸_${todayISO()}_${mode}.pdf`;

      const opt = {
        margin: [8, 8, 8, 8],
        filename,
        // âœ… í•µì‹¬: JPEG ëŒ€ì‹  PNGë¡œ ê³ ì • -> Unsupported image type í•´ê²°
        image: { type: "png" },
        html2canvas: {
          scale,
          useCORS: true,
          backgroundColor: "#ffffff",
          logging: false,
          removeContainer: true
        },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait", compress: true },
        pagebreak: { mode: ["css", "legacy"] }
      };

      // Worker íŒ¨í„´
      const worker = html2pdf().set(opt).from(el);
      return { worker, filename };
    }

    document.getElementById("btnPdf").addEventListener("click", async () => {
      const btn = document.getElementById("btnPdf");
      const overlay = document.getElementById("pdfOverlay");
      const overlayMsg = document.getElementById("overlayMsg");
      const oldText = btn.textContent;

      try{
        resetDebug();
        render();

        btn.disabled = true;
        btn.textContent = "PDF ìƒì„± ì¤‘â€¦";
        overlay.style.display = "flex";

        const mode = getPdfMode();
        overlayMsg.textContent = (mode === "fast") ? "ë¹ ë¥¸ PDF ë³€í™˜ ì¤‘â€¦" : "ê³ í™”ì§ˆ PDF ë³€í™˜ ì¤‘â€¦";

        await new Promise(r => setTimeout(r, 80));

        logDebug("[step] worker ìƒì„±");
        const { worker } = await makePdf(mode);

        logDebug("[step] save() ì‹œë„");
        await worker.save();
        logDebug("[ok] save() ì™„ë£Œ");
      } catch (e) {
        logDebug("[error] " + (e?.message || e));

        // fallback: ìƒˆ íƒ­ ë¯¸ë¦¬ë³´ê¸°
        try{
          logDebug("[fallback] blob ìƒì„± í›„ ìƒˆ íƒ­ ì—´ê¸°");
          const mode = getPdfMode();
          const { worker } = await makePdf(mode);
          const pdf = await worker.outputPdf("blob");
          const url = URL.createObjectURL(pdf);
          const w = window.open(url, "_blank", "noopener");
          if (!w) logDebug("[fallback] íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
          else logDebug("[ok] ìƒˆ íƒ­ ë¯¸ë¦¬ë³´ê¸° ì—´ë¦¼ (ê·¸ í™”ë©´ì—ì„œ ì €ì¥ ê°€ëŠ¥)");
        } catch (e2) {
          logDebug("[fallback error] " + (e2?.message || e2));
        }
      } finally {
        overlay.style.display = "none";
        btn.disabled = false;
        btn.textContent = oldText;
      }
    });

    document.getElementById("btnXlsx").addEventListener("click", () => {
      const title = document.getElementById("reportTitle").value || "ìˆ˜ìµ ì‹œë®¬ë ˆì´ì…˜ ë¦¬í¬íŠ¸";
      const org = document.getElementById("reportOrg").value || "";
      const opCount = +document.getElementById("opCount").value||0;
      const scCount = +document.getElementById("scCount").value||0;
      const rows = [
        ["ë¦¬í¬íŠ¸ ì œëª©", title],
        ["ê¸°ê´€/í”„ë¡œì íŠ¸", org],
        ["ìƒì„±ì¼", todayISO()],
        [],
        ["í•­ëª©", "ê°’"],
        ["ì™¸ë˜ ì›” ê±´ìˆ˜", opCount],
        ["ê²€ì§„ ì›” ê±´ìˆ˜", scCount],
      ];
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"] = [{wch:18},{wch:26}];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Report");
      XLSX.writeFile(wb, `ìˆ˜ìµë¦¬í¬íŠ¸_${todayISO()}.xlsx`, { compression:true });
    });

    render();
  </script>
</body>
</html>
